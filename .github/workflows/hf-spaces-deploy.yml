name: Deploy Demo to HuggingFace Spaces

on:
    push:
        branches:
            - main
        paths:
            - "src/demo/**"
            - ".github/workflows/hf-spaces-deploy.yml"
    workflow_dispatch:
        inputs:
            force_deploy:
                description: "Force deployment even without changes"
                required: false
                default: "false"
                type: boolean

env:
    HF_SPACE: samuellimabraz/quantum-assistant

jobs:
    deploy:
        runs-on: ubuntu-latest

        steps:
            - name: Checkout repository
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0
                  lfs: true

            - name: Setup Git LFS
              run: git lfs install

            - name: Configure Git
              run: |
                  git config --global user.email "github-actions[bot]@users.noreply.github.com"
                  git config --global user.name "github-actions[bot]"

            - name: Prepare Space files
              run: |
                  # Create a temporary directory for the Space
                  mkdir -p /tmp/hf-space

                  # Copy demo files
                  cp -r src/demo/* /tmp/hf-space/

                  # Remove unnecessary files
                  rm -rf /tmp/hf-space/node_modules
                  rm -rf /tmp/hf-space/.next
                  rm -f /tmp/hf-space/.env.local
                  rm -f /tmp/hf-space/.env

                  # Create HuggingFace Space README with YAML frontmatter
                  cat > /tmp/hf-space/README.md << 'EOF'
                  ---
                  title: Quantum Assistant
                  emoji: âš›ï¸
                  colorFrom: indigo
                  colorTo: purple
                  sdk: docker
                  pinned: true
                  app_port: 7860
                  license: apache-2.0
                  short_description: Multimodal VLM for Quantum Computing with Qiskit
                  ---

                  # Quantum Assistant Demo

                  Interactive demo for **Quantum Assistant** - A Multimodal Vision Language Model specialized for Quantum Computing with Qiskit.

                  ## Features

                  - ðŸ’¬ **Chat Interface**: Interact with the quantum-specialized VLM
                  - ðŸ“Š **Dataset Explorer**: Browse examples from the quantum-assistant dataset
                  - âš¡ **Code Execution**: Run Qiskit code directly in the browser
                  - ðŸ–¼ï¸ **Image Understanding**: Analyze quantum circuit diagrams, Bloch spheres, and histograms

                  ## Resources

                  - ðŸ“¦ [Dataset](https://huggingface.co/datasets/samuellimabraz/quantum-assistant)
                  - ðŸ¤– [Models](https://huggingface.co/collections/samuellimabraz/quantum-assistant)
                  - ðŸ’» [GitHub](https://github.com/samuellimabraz/quantum-assistant)

                  ## Configuration

                  Configure the model endpoint via Space secrets:

                  - `DEMO_MODEL_URL`: VLM API endpoint (OpenAI-compatible)
                  - `DEMO_MODEL_NAME`: Model identifier
                  - `DEMO_API_KEY`: API authentication key

                  ## Author

                  **Samuel Lima Braz** - UNIFEI (Universidade Federal de ItajubÃ¡)

                  Final Graduation Project - 2025
                  EOF

                  # Fix README indentation (remove leading spaces from heredoc)
                  sed -i 's/^          //' /tmp/hf-space/README.md

            - name: Push to HuggingFace Spaces
              env:
                  HF_TOKEN: ${{ secrets.HF_TOKEN }}
              run: |
                  cd /tmp/hf-space

                  # Initialize git repo
                  git init
                  git remote add space https://huggingface.co/spaces/${{ env.HF_SPACE }}

                  # Configure git for HF
                  git config http.postBuffer 524288000

                  # Add all files
                  git add -A

                  # Commit
                  git commit -m "Deploy demo from GitHub Actions - $(date +'%Y-%m-%d %H:%M:%S')" || echo "No changes to commit"

                  # Force push to HuggingFace Spaces
                  git push --force https://user:${HF_TOKEN}@huggingface.co/spaces/${{ env.HF_SPACE }} HEAD:main
